import{stringifyVariables as e,createRequest as r,formatDocument as t,makeOperation as i}from"@urql/core";import{share as a,map as n,filter as o,merge as s,mergeMap as l,empty as u,fromArray as d,makeSubject as p,tap as v}from"wonka";import{Kind as f,valueFromASTUntyped as y,print as c}from"graphql";var m=e=>e.name.value,h=e=>e.typeCondition.name.value,g=e=>e.alias?e.alias.value:e.name.value,k=[],_=e=>e.selectionSet?e.selectionSet.selections:k,O=e=>e.typeCondition?e.typeCondition.name.value:null,w=e=>e.kind===f.FIELD,b=e=>e.kind===f.INLINE_FRAGMENT,q=(e,r)=>{var t=null;if(e.arguments)for(var i=0,a=e.arguments.length;i<a;i++){var n=e.arguments[i],o=y(n.value,r);null!=o&&(t||(t={}),t[m(n)]=o)}return t},N=(e,r)=>{if(r&&e.variableDefinitions){for(var t={},i=0,a=e.variableDefinitions.length;i<a;i++){var n=m(e.variableDefinitions[i].variable);t[n]=r[n]}return t}},K=(e,r)=>{var t={};if(!r)return t;if(e.variableDefinitions)for(var i=0,a=e.variableDefinitions.length;i<a;i++){var n=e.variableDefinitions[i],o=m(n.variable);t[o]=void 0===r[o]&&n.defaultValue?y(n.defaultValue,r):r[o]}for(var s in r)s in t||(t[s]=r[s]);return t};function x(e,r,t){if(!e){var i=new Error((r||"Minfied Error #"+t+"\n")+"\nhttps://bit.ly/2XbVrpR#"+t);throw i.name="Graphcache Error",i}}new Set;var E=e=>{for(var r=0;r<e.definitions.length;r++)if(e.definitions[r].kind===f.OPERATION_DEFINITION)return e.definitions[r];x(!1,"",1)},M=e=>{for(var r={},t=0;t<e.definitions.length;t++){var i=e.definitions[t];i.kind===f.FRAGMENT_DEFINITION&&(r[m(i)]=i)}return r},S=(e,r)=>{for(var t=0;e.directives&&t<e.directives.length;t++){var i=e.directives[t],a=m(i);if(("include"===a||"skip"===a)&&i.arguments&&i.arguments[0]&&"if"===m(i.arguments[0])){var n=y(i.arguments[0].value,r);return"include"===a?!!n:!n}}return!0},A=(e,r)=>{for(var t=0;e.directives&&t<e.directives.length;t++){var i=e.directives[t];if("defer"===m(i)){for(var a=0;i.arguments&&a<i.arguments.length;a++){var n=i.arguments[t];if("if"===m(n))return!!y(n.value,r)}return!0}}return!1},T=(e,r,t)=>{var i=I(e,r,t);return!!i&&"NON_NULL"!==i.type.kind},L=(e,r,t)=>{var i=I(e,r,t);if(!i)return!1;var a="NON_NULL"===i.type.kind?i.type.ofType:i.type;return"LIST"===a.kind&&"NON_NULL"!==a.ofType.kind},F=(e,r,t)=>{if(!t)return!1;var i=O(r);return!i||t===i||(e.types.has(i)&&"OBJECT"===e.types.get(i).kind?i===t:(function(e,r){x(e.types.has(r)&&("INTERFACE"===e.types.get(r).kind||"UNION"===e.types.get(r).kind),"",5)}(e,i),C(e,t),e.isSubType(i,t)))},I=(e,r,t)=>{if(0!==t.indexOf("__")&&0!==r.indexOf("__"))return C(e,r),e.types.get(r).fields()[t]};function C(e,r){x(e.types.has(r)&&"OBJECT"===e.types.get(r).kind,"",3)}var D=(r,t)=>t?`${r}(${e(t)})`:r,$=(e,r)=>`${e}.${r}`,P=e=>{var r=e.indexOf("(");return r>-1?{fieldKey:e,fieldName:e.slice(0,r),arguments:JSON.parse(e.slice(r+1,-1))}:{fieldKey:e,fieldName:e,arguments:null}},R=e=>{var r=e.indexOf(".");return{entityKey:e.slice(0,r).replace(/%2e/g,"."),fieldKey:e.slice(r+1)}},j=()=>Object.create(null),J=null,Q=null,B=null,U=null,G=null,V=null,W=!1,z=e=>{var r;if(e){if(J.has(e))return e;r=Q.get(e)||{...e},Q.set(e,r)}else r={};return J.add(r),r},X=e=>!!e&&J.has(e),H=(e,r,t,i)=>{J=new WeakSet,Q=new WeakMap,B=e,U=r,G=new Set,W=!!i,t?"read"===B?V=t:i||r.optimisticOrder.length>1?(i||r.commutativeKeys.has(t)?i&&(-1===r.optimisticOrder.indexOf(t)||r.commutativeKeys.has(t)||r.optimisticOrder.splice(r.optimisticOrder.indexOf(t),1),r.commutativeKeys.delete(t)):ye(r,t),V=t,ce(r,t)):(V=null,he(r,t)):V=null},Y=()=>{var e=U,r=V;if(W=!1,V=null,r&&e.optimisticOrder.indexOf(r)>-1)for(var t=e.optimisticOrder.length;--t>=0&&e.refLock.has(e.optimisticOrder[t])&&e.commutativeKeys.has(e.optimisticOrder[t])&&!e.deferredKeys.has(e.optimisticOrder[t]);)ge(e.optimisticOrder[t]);J=null,Q=null,B=null,U=null,G=null,e.defer||(e.defer=!0,setTimeout((()=>{H("read",e,null),se(),_e(),Y(),e.defer=!1})))},Z=(e,r,t)=>{r&&!t&&e.deferredKeys.delete(r),H("write",e,r,t),Y()},ee=()=>(x(null!==G,"",2),G),re=(e,r,t,i)=>{var a=V?e.optimistic.get(V):e.base,n=a.get(r);void 0===n&&a.set(r,n=j()),void 0!==i||V?n[t]=i:delete n[t]},te=(e,r,t)=>{for(var i,a=!W&&"read"===B&&V&&U.commutativeKeys.has(V),n=0,o=U.optimisticOrder.length;n<o;n++){var s=U.optimisticOrder[n],l=e.optimistic.get(s);if(a=a&&s!==V,l&&(!a||!U.commutativeKeys.has(s))&&(!W||"write"===B||U.commutativeKeys.has(s))&&void 0!==(i=l.get(r))&&t in i)return i[t]}return void 0!==(i=e.base.get(r))?i[t]:void 0},ie=(e,r,t,i)=>{var a=r.get(t)||0,n=a+i;r.set(t,n),e&&(n<=0?e.add(t):a<=0&&n>0&&e.delete(t))},ae=(e,r,t,i)=>{if("string"==typeof t)ie(e,r,t,i);else if(Array.isArray(t))for(var a=0,n=t.length;a<n;a++)Array.isArray(t[a])?ae(e,r,t[a],i):t[a]&&ie(e,r,t[a],i)},ne=(e,r,t)=>{if(void 0!==t)for(var i in t)r.has(i)||(e.push(P(i)),r.add(i))},oe=(e,r,t,i)=>{ne(e,r,i.base.get(t));for(var a=0,n=U.optimisticOrder.length;a<n;a++){var o=i.optimistic.get(U.optimisticOrder[a]);void 0!==o&&ne(e,r,o.get(t))}},se=()=>{var{gc:e}=U;for(var r of e.keys()){if((U.refCount.get(r)||0)>0)return void e.delete(r);for(var t of U.refLock.keys()){var i=U.refLock.get(t);if(i){if((i.get(r)||0)>0)return;i.delete(r)}}U.refCount.delete(r),e.delete(r),U.records.base.delete(r);var a=U.links.base.get(r);if(a)for(var n in U.links.base.delete(r),a)ae(e,U.refCount,a[n],-1)}},le=(e,r)=>{"__typename"!==r&&(e!==U.queryRootKey?G.add(e):void 0!==r&&G.add($(e,r)))},ue=(e,r)=>{!W&&U.storage&&U.persist.add(((e,r)=>`${e.replace(/\./g,"%2e")}.${r}`)(e,r))},de=(e,r)=>(le(e,r),te(U.records,e,r)),pe=(e,r)=>(le(e,r),te(U.links,e,r)),ve=(e,r,t)=>{le(e,r),ue(e,r),re(U.records,e,r,t)},fe=(e,r,t)=>{var i,a,n,o=U;V?((i=o.refLock.get(V))||o.refLock.set(V,i=new Map),a=o.links.optimistic.get(V)):(i=o.refCount,a=o.links.base,n=o.gc);var s=a&&a.get(e),l=s&&s[r];le(e,r),ue(e,r),re(o.links,e,r,t),ae(n,i,l,-1),ae(n,i,t,1)},ye=(e,r,t)=>{t?e.deferredKeys.add(r):e.deferredKeys.delete(r);var i=e.optimisticOrder.indexOf(r);if(i>-1){if(!t&&e.commutativeKeys.has(r))return;e.optimisticOrder.splice(i,1),me(e,r)}for(i=0;t&&i<e.optimisticOrder.length&&!e.deferredKeys.has(e.optimisticOrder[i])&&(!e.refLock.has(e.optimisticOrder[i])||!e.commutativeKeys.has(e.optimisticOrder[i]));i++);e.optimisticOrder.splice(i,0,r),e.commutativeKeys.add(r)},ce=(e,r)=>{-1===e.optimisticOrder.indexOf(r)&&e.optimisticOrder.unshift(r),e.refLock.has(r)||(e.refLock.set(r,new Map),e.links.optimistic.set(r,new Map),e.records.optimistic.set(r,new Map))},me=(e,r)=>{e.refLock.has(r)&&(e.refLock.delete(r),e.records.optimistic.delete(r),e.links.optimistic.delete(r),e.deferredKeys.delete(r))},he=(e,r)=>{var t=e.optimisticOrder.indexOf(r);t>-1&&(e.optimisticOrder.splice(t,1),e.commutativeKeys.delete(r)),me(e,r)},ge=e=>{var r=G;G=new Set;var t=U.links.optimistic.get(e);if(t)for(var i of t.entries()){var a=i[0],n=i[1];for(var o in n)fe(a,o,n[o])}var s=U.records.optimistic.get(e);if(s)for(var l of s.entries()){var u=l[0],d=l[1];for(var p in d)ve(u,p,d[p])}G=r,he(U,e)},ke=e=>{var{links:r,records:t}=U,i=[],a=new Set;return le(e),oe(i,a,e,r),oe(i,a,e,t),i},_e=()=>{if(U.storage){W=!0,B="read";var r=j();for(var t of U.persist.keys()){var{entityKey:i,fieldKey:a}=R(t),n=void 0;r[t]=void 0!==(n=pe(i,a))?`:${e(n)}`:void 0!==(n=de(i,a))?e(n):void 0}W=!1,U.storage.writeData(r),U.persist.clear()}},Oe={current:null},we={current:!1},be=e=>e.__internal.path.length>0&&e.__internal.errorMap?e.__internal.errorMap[e.__internal.path.join(".")]:void 0,qe=(e,r,t,i,a,n,o)=>{var s={store:e,variables:r,fragments:t,parent:{__typename:i},parentTypeName:i,parentKey:a,parentFieldKey:"",fieldName:"",error:void 0,partial:!1,optimistic:!!n,__internal:{path:[],errorMap:void 0}};if(o&&o.graphQLErrors)for(var l=0;l<o.graphQLErrors.length;l++){var u=o.graphQLErrors[l];u.path&&u.path.length&&(s.__internal.errorMap||(s.__internal.errorMap=Object.create(null)),s.__internal.errorMap[u.path.join(".")]=u)}return s},Ne=(e,r,t,i,a,n)=>{Oe.current=e,e.parent=r,e.parentTypeName=t,e.parentKey=i,e.parentFieldKey=a,e.fieldName=n,e.error=be(e)},Ke=(e,r,t,i)=>{if(!r)return!1;var a=O(e);return!a||r===a||"write"===B||!_(e).some((e=>{if(!w(e))return!1;var r=D(m(e),q(e,i));return!((e,r)=>void 0!==de(e,r)||void 0!==pe(e,r))(t,r)}))},xe=(e,r,t,i)=>{var a,n=!1,o=0;return function(){if(!we.current&&n&&(we.current=n),a){var s=a();if(null!=s)return s;a=void 0,n=!1}for(;o<t.length;){var l=t[o++];if(S(l,i.variables)){if(w(l))return l;var u=b(l)?l:i.fragments[m(l)];if(void 0!==u&&(i.store.schema?F(i.store.schema,u,e):Ke(u,e,r,i.variables)))return n=!!A(l,i.variables),!we.current&&n&&(we.current=n),(a=xe(e,r,_(u),i))()}}}},Ee=e=>null==e?null:e,Me=(e,r)=>{if(null==r)return r;if(Array.isArray(r)){for(var t=new Array(r.length),i=0,a=t.length;i<a;i++)t[i]=Me(e,r[i]);return t}return e.keyOfEntity(r)},Se=(e,r,t,i,a)=>{H("write",e.data,a||null);var n=Ae(e,r,t,i);return Y(),n},Ae=(e,r,t,i,a)=>{var n=E(r.query),o={data:t,dependencies:ee()},s=e.rootFields[n.operation],l=qe(e,K(n,r.variables),M(r.query),s,s,!!a,i);return Te(l,s,_(n),t),o},Te=(e,r,t,i)=>{var a=r===e.store.rootFields.query,n=!a&&!!e.store.rootNames[r],o=n||a?r:i.__typename;if(o){n||a||!r||ve(r,"__typename",o);for(var s,l=xe(o,r||o,t,e);s=l();){var u=m(s),d=q(s,e.variables),p=D(u,d),v=g(s),f=i[e.optimistic?u:v];if(!("__typename"===u||void 0===f&&we.current)){e.__internal.path.push(v);var y=void 0;if(e.optimistic&&n){if(!(y=e.store.optimisticMutations[u]))continue}else e.optimistic&&"function"==typeof f&&(y=f);if(y&&(Ne(e,i,o,o,p,u),f=Ee(y(d||{},e.store,e))),s.selectionSet)if(r&&!n){var c=$(r,p),h=Le(e,_(s),Ee(f),c);fe(r||o,p,h)}else Le(e,_(s),Ee(f));else r&&!n&&ve(r||o,p,null===f&&be(e)?void 0:f);if(n){var k=e.store.updates[o][u];k&&(Ne(e,i,o,o,$(o,p),u),i[u]=f,k(i,d||{},e.store,e))}e.__internal.path.pop()}}}},Le=(e,r,t,i)=>{if(Array.isArray(t)){for(var a=new Array(t.length),n=0,o=t.length;n<o;n++){e.__internal.path.push(n);var s=i?$(i,`${n}`):void 0,l=Le(e,r,t[n],s);a[n]=l,e.__internal.path.pop()}return a}if(null===t)return be(e)?void 0:null;var u=e.store.keyOfEntity(t)||i;return Te(e,u,r,t),u||null};class Fe{constructor(e){Fe.prototype.__init.call(this),Fe.prototype.__init2.call(this),e||(e={}),this.resolvers=e.resolvers||{},this.optimisticMutations=e.optimistic||{},this.keys=e.keys||{};var r,t="Query",i="Mutation",a="Subscription";if(e.schema){var n=(({__schema:e})=>{var r=new Map,t=e=>{var r;return()=>{if(!r){r={};for(var t=0;t<e.length;t++)r[e[t].name]=e[t]}return r}},i=e=>{switch(e.kind){case"OBJECT":case"INTERFACE":return{name:e.name,kind:e.kind,interfaces:t(e.interfaces||[]),fields:t(e.fields.map((e=>({name:e.name,type:e.type,args:t(e.args)}))))};case"UNION":return{name:e.name,kind:e.kind,types:t(e.possibleTypes||[])}}},a={query:e.queryType?e.queryType.name:null,mutation:e.mutationType?e.mutationType.name:null,subscription:e.subscriptionType?e.subscriptionType.name:null,types:void 0,isSubType(e,t){var i=r.get(e),a=r.get(t);return!!(i&&a&&("UNION"===i.kind?i.types()[t]:"OBJECT"!==i.kind&&"OBJECT"===a.kind?a.interfaces()[e]:e===t))}};if(e.types){a.types=r;for(var n=0;n<e.types.length;n++){var o=e.types[n];if(o&&o.name){var s=i(o);s&&r.set(o.name,s)}}}return a})(e.schema);t=n.query||t,i=n.mutation||i,a=n.subscription||a,n.types&&(this.schema=n)}this.updates={[i]:e.updates&&e.updates.Mutation||{},[a]:e.updates&&e.updates.Subscription||{}},this.rootFields={query:t,mutation:i,subscription:a},this.rootNames={[t]:"query",[i]:"mutation",[a]:"subscription"},this.data=(r=t,{defer:!1,gc:new Set,persist:new Set,queryRootKey:r,refCount:new Map,refLock:new Map,links:{optimistic:new Map,base:new Map},records:{optimistic:new Map,base:new Map},deferredKeys:new Set,commutativeKeys:new Set,optimisticOrder:[],storage:null})}__init(){this.keyOfField=D}keyOfEntity(e){return Oe.current&&e===Oe.current.parent?Oe.current.parentKey:null==e||"string"==typeof e?e||null:e.__typename?this.rootNames[e.__typename]?e.__typename:(this.keys[e.__typename]?r=this.keys[e.__typename](e):null!=e.id?r=`${e.id}`:null!=e._id&&(r=`${e._id}`),r?`${e.__typename}:${r}`:null):null;var r}resolve(e,r,t){var i=D(r,t),a=this.keyOfEntity(e);if(!a)return null;var n=de(a,i);return void 0!==n?n:pe(a,i)||null}__init2(){this.resolveFieldByKey=this.resolve}invalidate(e,r,t){var i=this.keyOfEntity(e);x(i,"",19),((e,r,t)=>{for(var i=r?[{fieldKey:D(r,t)}]:ke(e),a=0,n=i.length;a<n;a++){var{fieldKey:o}=i[a];void 0!==pe(e,o)?fe(e,o,void 0):ve(e,o,void 0)}})(i,r,t)}inspectFields(e){var r=this.keyOfEntity(e);return r?ke(r):[]}updateQuery(e,i){var a=r(e.query,e.variables);a.query=t(a.query);var n=i(this.readQuery(a));null!==n&&Ae(this,a,n)}readQuery(e){var i=r(e.query,e.variables);return i.query=t(i.query),Ce(this,i).data}readFragment(e,r,i,a){return Pe(this,t(e),r,i,a)}writeFragment(e,r,i,a){((e,r,t,i,a)=>{var n,o=M(r);if(a){if(!(n=o[a]))return null}else if(!(n=o[Object.keys(o)[0]]))return null;var s=h(n),l={__typename:s,...t},u=e.keyOfEntity(l);if(u){var d=qe(e,i||{},o,s,u,void 0);Te(d,u,_(n),l)}})(this,t(e),r,i,a)}link(e,r,t,i){var a=void 0!==i?t:null,n=void 0!==i?i:t,o=Me(this,e);"string"==typeof o&&fe(o,D(r,a),Me(this,n))}}var Ie=(e,r,t,i,a)=>{H("read",e.data,a);var n=Ce(e,r,t,i);return Y(),n},Ce=(e,r,t,i)=>{var a=E(r.query),n=e.rootFields[a.operation],o=_(a),s=qe(e,K(a,r.variables),M(r.query),n,n,!1,i);t||(t=z());var l=n!==s.store.rootFields.query?De(s,n,o,t):Re(s,n,o,t);return{dependencies:ee(),partial:s.partial||!l,data:l||null}},De=(e,r,t,i)=>{if("string"!=typeof(e.store.rootNames[r]?r:i.__typename))return i;for(var a,n=xe(r,r,t,e),o=!1,s=z(i);a=n();){var l,u=g(a),d=i[u];e.__internal.path.push(u),l=a.selectionSet&&null!==d?$e(e,_(a),Ee(d)):d,o=o||l!==d,void 0!==l&&(s[u]=l),e.__internal.path.pop()}return o?s:i},$e=(e,r,t)=>{if(Array.isArray(t)){for(var i=new Array(t.length),a=!1,n=0,o=t.length;n<o;n++)e.__internal.path.push(n),i[n]=$e(e,r,t[n]),a=a||i[n]!==t[n],e.__internal.path.pop();return a?i:t}if(null===t)return null;var s=e.store.keyOfEntity(t);return null!==s?Re(e,s,r,t)||null:De(e,t.__typename,r,t)},Pe=(e,r,t,i,a)=>{var n,o=M(r);if(a){if(!(n=o[a]))return null}else if(!(n=o[Object.keys(o)[0]]))return null;var s=h(n);"string"==typeof t||t.__typename||(t.__typename=s);var l=e.keyOfEntity(t);if(!l)return null;var u=qe(e,i||{},o,s,l);return Re(u,l,_(n),z())||null},Re=(e,r,t,i,a)=>{var{store:n}=e,o=r===n.rootFields.query,s=a&&n.keyOfEntity(a)||r,l=o?r:de(s,"__typename")||a&&a.__typename;if("string"==typeof l&&(!a||l===a.__typename)){for(var u,d=xe(l,s,t,e),p=!1,v=!1,f=l!==i.__typename,y=z(i);void 0!==(u=d());){var c=m(u),h=q(u,e.variables),k=g(u),O=D(c,h),w=$(s,O),b=de(s,O),N=a?a[c]:void 0,K=n.resolvers[l];e.__internal.path.push(k);var E=void 0;if("__typename"===c)E=l;else if(void 0!==N&&void 0===u.selectionSet)E=N;else if("read"===(x(null!==B,"",2),B)&&K&&"function"==typeof K[c]){if(Ne(e,y,l,s,w,c),void 0!==b&&(y[k]=b),E=K[c](y,h||{},n,e),u.selectionSet&&(E=je(e,l,c,w,_(u),void 0!==y[k]?y[k]:i[k],E,X(i))),n.schema&&null===E&&!T(n.schema,l,c))return}else if(u.selectionSet)if(void 0!==N)E=je(e,l,c,w,_(u),void 0!==y[k]?y[k]:i[k],N,X(i));else{var M=pe(s,O);void 0!==M?E=Je(e,M,l,c,_(u),void 0!==y[k]?y[k]:i[k],X(i)):"object"==typeof b&&null!==b&&(E=b)}else E=b;if(void 0===E&&we.current)p=!0;else if(void 0===E&&(n.schema&&T(n.schema,l,c)||be(e)))v=!0,E=null;else{if(void 0===E)return void e.__internal.path.pop();p=p||"__typename"!==c}e.__internal.path.pop(),f=f||E!==i[k],void 0!==E&&(y[k]=E)}return e.partial=e.partial||v,o&&v&&!p?void 0:f?y:i}},je=(e,r,t,i,a,n,o,s)=>{if(Array.isArray(o)){for(var{store:l}=e,u=!!l.schema&&L(l.schema,r,t),d=new Array(o.length),p=!Array.isArray(n)||o.length!==n.length,v=0,f=o.length;v<f;v++){e.__internal.path.push(v);var y=je(e,r,t,$(i,`${v}`),a,null!=n?n[v]:void 0,o[v],s);if(e.__internal.path.pop(),void 0===y&&!u)return;e.partial=e.partial||void 0===y&&u,d[v]=null!=y?y:null,p=p||d[v]!==n[v]}return p?d:n}if(null==o)return o;if(s&&null===n)return null;if(Qe(o)){var c=n||z();return"string"==typeof o?Re(e,o,a,c):Re(e,i,a,c,o)}},Je=(e,r,t,i,a,n,o)=>{if(Array.isArray(r)){for(var{store:s}=e,l=!!s.schema&&L(s.schema,t,i),u=new Array(r.length),d=!Array.isArray(n)||u.length!==n.length,p=0,v=r.length;p<v;p++){e.__internal.path.push(p);var f=Je(e,r[p],t,i,a,null!=n?n[p]:void 0,o);if(e.__internal.path.pop(),void 0===f&&!l)return;e.partial=e.partial||void 0===f&&l,u[p]=f||null,d=d||u[p]!==n[p]}return d?u:n}return null===r||null===n&&o?null:Re(e,r,a,n||z())},Qe=e=>"string"==typeof e||"object"==typeof e&&"string"==typeof e.__typename,Be=(e,r)=>i(e.kind,e,{...e.context,meta:{...e.context.meta,cacheOutcome:r}}),Ue=(e,r)=>i(e.kind,e,{...e.context,requestPolicy:r}),Ge=e=>({forward:r,client:p})=>{var v=new Fe(e);e&&e.storage&&e.storage.readData().then((r=>{((e,r,t)=>{for(var i in H("write",e,null),t){var a=t[i];if(void 0!==a){var{entityKey:n,fieldKey:o}=R(i);":"===a[0]?void 0===pe(n,o)&&fe(n,o,JSON.parse(a.slice(1))):void 0===de(n,o)&&ve(n,o,JSON.parse(a))}}Y(),e.storage=r})(v.data,e.storage,r)}));var f=new Map,y=[],c=new Map,m=new Map,h=new Set,g=new Set,k=new Map,_=e=>{for(var r of e.values())if(h.has(r))return!0;return!1},O=(e,r)=>{if(r)for(var t of r.values()){var i=k.get(t);if(i)for(var a of i.values())e.add(a)}},w=(e,r)=>{for(var t of r.values())if(t!==e.key){var i=c.get(t);if(i){c.delete(t);var a="cache-first";g.has(t)&&(g.delete(t),a="cache-and-network"),p.reexecuteOperation(Ue(i,a))}}},b=e=>{if("query"===e.kind)ye(v.data,e.key);else if("teardown"===e.kind)c.delete(e.key),m.delete(e.key),Z(v.data,e.key);else if("mutation"===e.kind&&"network-only"!==e.context.requestPolicy){var{dependencies:r}=((e,r,t)=>{H("write",e.data,t,!0);var i=Ae(e,r,{},void 0,!0);return Y(),i})(v,e,e.key);if(r.size){for(var a of r.values())h.add(a);f.set(e.key,r);var n=new Set;O(n,r),w(e,n)}}return i(e.kind,{key:e.key,query:t(e.query),variables:e.variables?N(E(e.query),e.variables):e.variables},e.context)},q=(e,r)=>{for(var t of r.values()){var i=k.get(t);i||k.set(t,i=new Set),i.add(e.key),c.set(e.key,e)}},K=e=>{var r=Ie(v,e,m.get(e.key)),t=r.data?r.partial?"partial":"hit":"miss";return m.set(e.key,r.data),q(e,r.dependencies),{outcome:t,operation:e,data:r.data,dependencies:r.dependencies}},x=(e,r)=>{var t,{operation:i,error:a,extensions:n}=e,{key:o}=i;if("mutation"===i.kind){var s=f.get(o);O(r,s),f.delete(o)}ye(v.data,i.key,"subscription"===i.kind||e.hasNext);var l=e.data;if(l){var u=Se(v,i,l,e.error,o).dependencies;O(r,u);var d=Ie(v,i,"query"===i.kind&&m.get(i.key)||l,e.error,o);l=d.data,"query"===i.kind&&(O(r,t=d.dependencies),m.set(i.key,e.data))}else Z(v.data,i.key);return t&&q(e.operation,t),{data:l,error:a,extensions:n,operation:i}};return e=>{var t=a(e),i=a(n(K)(o((e=>"query"===e.kind&&"network-only"!==e.context.requestPolicy))(t))),c=o((e=>"query"!==e.kind||"network-only"===e.context.requestPolicy))(t),m=n((e=>Be(e.operation,"miss")))(o((e=>"miss"===e.outcome&&"cache-only"!==e.operation.context.requestPolicy&&!_(e.dependencies)))(i)),k=n((e=>{var{operation:r,outcome:t,dependencies:i}=e,a={operation:Be(r,t),data:e.data,error:e.error,extensions:e.extensions};return("cache-and-network"===r.context.requestPolicy||"cache-first"===r.context.requestPolicy&&"partial"===t)&&(a.stale=!0,_(i)?"cache-and-network"===r.context.requestPolicy&&g.add(r.key):p.reexecuteOperation(Ue(r,"network-only"))),a}))(o((e=>"miss"!==e.outcome||"cache-only"===e.operation.context.requestPolicy))(i)),O=a(r(n(b)(s([c,m])))),q=n((e=>{var r=new Set,t=x(e,r);return w(e.operation,r),t}))(o((e=>!f.has(e.operation.key)))(O)),N=l((e=>{if(y.push(e)<f.size)return u;for(var r=0;r<y.length;r++)ye(v.data,y[r].operation.key);h.clear();for(var t,i=[],a=new Set;t=y.shift();)i.push(x(t,a));return w(e.operation,a),d(i)}))(o((e=>f.has(e.operation.key)))(O));return s([q,N,k])}},Ve=e=>e&&e.networkError&&!e.response&&("undefined"!=typeof navigator&&!1===navigator.onLine||/request failed|failed to fetch|network\s?error/i.test(e.networkError.message)),We=e=>t=>{var{storage:n}=e;if(n&&n.onOnline&&n.readMetadata&&n.writeMetadata){var{forward:l,client:u,dispatchDebug:d}=t,{source:f,next:y}=p(),h=e.optimistic||{},g=[],k=()=>{for(var e=[],r=0;r<g.length;r++){var t=g[r];"mutation"===t.kind&&e.push({query:c(t.query),variables:t.variables})}n.writeMetadata(e)},O=!1,q=()=>{if(!O){O=!0;for(var e=0;e<g.length;e++){var r=g[e];"mutation"===r.kind&&y(i("teardown",r))}for(var t=0;t<g.length;t++)u.reexecuteOperation(g[t]);g.length=0,O=!1,k()}};n.onOnline(q),n.readMetadata().then((e=>{if(e){for(var t=0;t<e.length;t++)g.push(u.createRequestOperation("mutation",r(e[t].query,e[t].variables)));q()}}));var N=Ge({...e,storage:{...n,readData:()=>n.readData().finally(q)}})({client:u,dispatchDebug:d,forward:e=>o((e=>"mutation"===e.operation.kind&&Ve(e.error)&&((e,r)=>{for(var t,i=r.variables||{},a=M(r.query),n=[..._(E(r.query))];t=n.pop();)if(S(t,i))if(w(t)){if(e[m(t)])return!0}else{var o=b(t)?t:a[m(t)];o&&n.push(..._(o))}return!1})(h,e.operation)?(g.push(K.get(e.operation.context._instance)||e.operation),k(),!1):("mutation"!==e.operation.kind||e.error||K.delete(e.operation.context._instance),!0)))(l(e))}),K=new WeakMap;return e=>{var r=a(v((e=>{"mutation"===e.kind&&K.set(e.context._instance,e)}))(e)),t=s([f,r]);return o((e=>"query"!==e.operation.kind||!Ve(e.error)||(y(Ue(e.operation,"cache-only")),g.push(e.operation),!1)))(N(t))}}return Ge(e)(t)};export{Fe as Store,Ge as cacheExchange,We as offlineExchange,Ie as query,Se as write};
//# sourceMappingURL=urql-exchange-graphcache.min.mjs.map
